<div>
    <cly-header>
        <template v-slot:header-top>
            <cly-back-link></cly-back-link>
        </template>
        <template v-slot:header-left>
            <h2>
                {{crashgroupName}}
                <cly-tooltip-icon></cly-tooltip-icon>
            </h2>
        </template>
    </cly-header>
    <cly-main>
        <cly-section class="crashgroup-common-metrics" v-if="!!commonMetrics">
            <div class="crashgroup-common-metrics__tiles-container bu-columns bu-is-gapless bu-is-mobile"">
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth">
                    <template v-slot:title>Platform</template>
                    <template v-slot:value>{{commonMetrics.platform}}</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth" tooltip="Hello">
                    <template v-slot:title>Occurances</template>
                    <template v-slot:value>{{commonMetrics.occurances}}</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth">
                    <template v-slot:title>Affected Users</template>
                    <template v-slot:value>{{commonMetrics.affectedUsers}}</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth" tooltip="Hello">
                    <template v-slot:title>Crash Frequency</template>
                    <template v-slot:value>{{commonMetrics.crashFrequency.toFixed(2)}}</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth">
                    <template v-slot:title>Latest App Version</template>
                    <template v-slot:value>{{commonMetrics.latestAppVersion}}</template>
                </cly-crashes-dashboard-tile>
            </div>
        </cly-section>
        <cly-section id="crash-tabs" v-if="!!(crashgroup && crashgroup.error)">
            <el-tabs v-model="currentTab" type="card">
                <el-tab-pane label="Stacktrace" name="stacktrace">
                    <crash-stacktrace :code="crashgroup.error">
                        <template v-slot:header-right>
                            <a class="crash-link text-medium bu-mr-5" :href="'/dashboard#/crashes/' + crashgroup._id + '/binary-images/' + crashgroup.lrid" v-if="!!crashgroup.binary_images">Show Binary Images</a>
                            <a class="crash-link text-medium" :href="'/o/crashes/download_stacktrace?auth_token=' + authToken +'&app_id=' + appId + '&crash_id=' + crashgroup.lrid" download>Download Stacktrace</a>
                        </template>
                    </crash-stacktrace>
                </el-tab-pane>
                <el-tab-pane name="comments">
                    <span slot="label">
                        Comments <span class="bu-tag" v-if="crashgroup && crashgroup.comments && (crashgroup.comments.length > 0)">{{crashgroup.comments.length}}</span>
                    </span>
                    <div class="bu-mx-5 bu-mt-5 bu-is-flex bu-is-flex-direction-column bu-is-align-items-center" v-if="!crashgroup || crashgroup && crashgroup.comments.length === 0">
                        <div><h4>No comments, yet...</h4></div>
                        <div class="text-small color-cool-gray-50">No comments here right now. Add a comment to share your thoughts.</div>
                    </div>
                    <el-card class="bu-mx-5 bu-mt-5 bu-p-4" shadow="never" :body-style="{padding: '0px'}" v-for="comment in crashgroup.comments">
                        <div class="bu-is-flex bu-is-flex-direction-column">
                            <div class="bu-is-flex bu-is-flex-direction-row bu-is-justify-content-space-between bu-mb-4">
                                <div class="bu-is-flex bu-is-flex-direction-column">
                                    <div class="text-medium">{{comment.author}}</div>
                                    <div class="text-small color-cool-gray-50" v-html="formatTimeAgo(comment.time)"></div>
                                </div>
                                <div>
                                    <cly-more-options @command="handleCommentCommand($event, comment)" v-if="commentIsMine(comment)">
                                        <el-dropdown-item command="edit-comment">Edit</el-dropdown-item>
                                        <el-dropdown-item command="delete-comment">Delete</el-dropdown-item>
                                    </cly-more-options>
                                </div>
                            </div>
                            <div class="text-medium">
                                {{comment.text}}
                            </div>
                        </div>
                        <div>
                        </div>
                    </el-card>
                    <div class="bu-m-5">
                        <el-input type="textarea" autosize placeholder="Enter your comment" v-model="commentInput"></el-input>
                        <div class="bu-level bu-mt-3">
                            <div class="bu-left">
                            </div>
                            <div class="bu-right">
                                <div v-if="!!commentBeingEdited">
                                    <el-button size="small" type="primary" @click="stopEditingComment">Cancel</el-button>
                                    <el-button size="small" type="primary" @click="saveComment">Save</el-button>
                                </div>
                                <div v-else-if="!!commentInput">
                                    <el-button size="small" type="primary" @click="saveComment">Add Comment</el-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </cly-section>
        <cly-section class="crashgroup-mobile-diagnostics" title="Crash Metrics" v-if="!!mobileMetrics">
            <div class="crashgroup-mobile-diagnostics__tiles-container bu-columns bu-is-gapless bu-is-mobile">
                <cly-crashes-dashboard-tile columnWidth="is-one-fifth" v-for="diagnosticKey in diagnosticsOrder">
                    <div class="crashgroup-mobile-diagnostics__tile-content bu-column bu-columns bu-py-0 bu-m-0 bu-is-flex-direction-column bu-is-justify-content-space-between">
                        <div class="text-medium text-uppercase">{{diagnosticKey}}</div>
                        <div>
                            <h2>{{mobileDiagnostics[diagnosticKey].average.toFixed(2)}} %</h2>
                            <div class="text-small color-cool-gray-50">Average</div>
                        </div>
                        <div class="bu-columns bu-m-0 bu-is-justify-content-space-between">
                            <div>
                                {{mobileDiagnostics[diagnosticKey].min.toFixed(2)}}
                                <div class="text-small color-cool-gray-50">Average</div>
                            </div>
                            <div>
                                {{mobileDiagnostics[diagnosticKey].max.toFixed(2)}}
                                <div class="text-small color-cool-gray-50">Average</div>
                            </div>
                        </div>
                    </div>
                </cly-crashes-dashboard-tile>
            </div>
        </cly-section>
        <cly-section class="crashgroup-mobile-metrics" v-if="!!mobileMetrics">
            <div class="crashgroup-mobile-metrics__tiles-container bu-columns bu-is-gapless bu-is-mobile">
                <cly-crashes-dashboard-tile columnWidth="3">
                    <template v-slot:title>Rooted / Jailbroken</template>
                    <template v-slot:value>{{mobileMetrics.rootedPercent.toFixed(2)}} %</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="3" tooltip="Hello">
                    <template v-slot:title>Crashed when Online</template>
                    <template v-slot:value>{{mobileMetrics.onlinePercent.toFixed(2)}} %</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="3" tooltip="Hello">
                    <template v-slot:title>Crashed when Muted</template>
                    <template v-slot:value>{{mobileMetrics.mutedPercent.toFixed(2)}} %</template>
                </cly-crashes-dashboard-tile>
                <cly-crashes-dashboard-tile columnWidth="3" tooltip="Hello">
                    <template v-slot:title>Crashed in Background</template>
                    <template v-slot:value>{{mobileMetrics.backgroundPercent.toFixed(2)}} %</template>
                </cly-crashes-dashboard-tile>
            </div>
        </cly-section>
        <cly-section>
            <template v-slot:header>
                <span class="bu-mr-2">Fatal Crash Occurances by</span>
                <el-select v-model="chartBy">
                    <el-option v-for="item in chartByOptions" :key="item.value" :label="item.label" :value="item.value"></el-option>
                </el-select>
            </template>
            <cly-chart-bar :option="chartData"></cly-chart-bar>
        </cly-section>
        <cly-section title="Crash Occurances by Users?">
            <cly-datatable-n :rows="crashes" ref="tableData" @row-click="handleRowClick">
                <template v-slot="scope">
                    <el-table-column type="expand">
                        <template slot-scope="props">
                            <el-card class="bu-mb-5" shadow="never" :body-style="{padding: '0px'}">
                                <div class="bu-columns bu-is-gapless bu-is-mobile">
                                    <cly-crashes-dashboard-tile :columnWidth="props.row.custom ? 3 : 4">
                                        <div class="bu-p-5 bu-is-align-self-flex-start">
                                            <div class="text-medium text-uppercase font-weight-bold">build info</div>
                                            <pre class="crash-pre">{{crashMetric(props.row, "build_info")}}</pre>
                                        </div>
                                    </cly-crashes-dashboard-tile>
                                    <cly-crashes-dashboard-tile :columnWidth="props.row.custom ? 3 : 4">
                                        <div class="bu-p-5 bu-is-align-self-flex-start">
                                            <div class="text-medium text-uppercase font-weight-bold">device</div>
                                            <pre class="crash-pre">{{crashMetric(props.row, "device")}}</pre>
                                        </div>
                                    </cly-crashes-dashboard-tile>
                                    <cly-crashes-dashboard-tile :columnWidth="props.row.custom ? 3 : 4">
                                        <div class="bu-p-5 bu-is-align-self-flex-start">
                                            <div class="text-medium text-uppercase font-weight-bold">device state</div>
                                            <pre class="crash-pre">{{crashMetric(props.row, "device_state")}}</pre>
                                        </div>
                                    </cly-crashes-dashboard-tile>
                                    <cly-crashes-dashboard-tile columnWidth="4" v-if="props.row.custom">
                                        <div class="bu-p-5 bu-is-align-self-flex-start">
                                            <div class="text-medium text-uppercase font-weight-bold">custom</div>
                                            <pre class="crash-pre">{{crashMetric(props.row, "custom")}}</pre>
                                        </div>
                                    </cly-crashes-dashboard-tile>
                                </div>
                            </el-card>
                            <el-card class="bu-mb-5" shadow="never" :body-style="{padding: '0px'}">
                                <crash-stacktrace :code="props.row.error">
                                    <template v-slot:header-right>
                                        <a class="crash-link text-medium bu-mr-5" :href="'/dashboard#/crashes/' + crashgroup._id + '/binary-images/' + props.row._id" v-if="!!props.row.binary_images">Show Binary Images</a>
                                        <a class="crash-link text-medium" :href="'/o/crashes/download_stacktrace?auth_token=' + authToken +'&app_id=' + appId + '&crash_id=' + props.row._id" download>Download Stacktrace</a>
                                    </template>
                                </crash-stacktrace>
                            </el-card>
                            <el-card class="bu-mb-5" shadow="never" :body-style="{padding: '0px'}" v-if="eventLogsEnabled">
                                <div class="bu-p-5 bu-is-align-self-flex-start">
                                    <div class="bu-level bu-is-mobile">
                                        <div class="bu-level-left">
                                            <div class="text-medium text-uppercase font-weight-bold">Event Logs</div>
                                        </div>
                                        <div class="bu-level-right">
                                            <el-button type="primary" :loading="isEventLogBeingGeneratedFor(props.row._id)" @click="generateEventLogs(props.row._id)">
                                                {{!props.row.eventlog ? "Generate" : "Regenerate"}}
                                            </el-button>
                                        </div>
                                    </div>
                                    <pre class="crash-pre">{{crashEventLog(props.row._id)}}</pre>
                                </div>
                            </el-card>
                            <el-card class="bu-mb-5" shadow="never" :body-style="{padding: '0px'}" v-if="!!props.row.logs">
                                <div class="bu-p-5 bu-is-align-self-flex-start">
                                    <div class="text-medium text-uppercase font-weight-bold">SDK Logs</div>
                                    <pre class="crash-pre">{{props.row.logs}}</pre>
                                </div>
                            </el-card>
                        </template>
                    </el-table-column>
                    <el-table-column prop="ts" label="Crashed" width="210" sortable>
                        <template slot-scope="col">
                            <span v-html="formatTimeAgo(col.row.ts)"></span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="os" label="Os Version" width="250">
                        <template slot-scope="col">
                            {{col.row.os}} {{col.row.os_version}}
                        </template>
                    </el-table-column>
                    <el-table-column prop="device" label="Device" width="199px" sortable></el-table-column>
                    <el-table-column prop="app_version" label="App Version" width="161" sortable></el-table-column>
                    <el-table-column prop="uid" label="User ID" sortable></el-table-column>
                </template>
            </cly-datatable-n>
        </cly-section>
    </cly-main>
</div>